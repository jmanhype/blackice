asyncapi: 3.0.0
info:
  title: NeonCompliance WebSocket API
  version: 1.0.0
  description: |
    Real-time WebSocket API for NeonCompliance platform.

    ## Connection
    Connect to `wss://api.neoncompliance.io/v1/socket` with JWT token in query string:
    ```
    wss://api.neoncompliance.io/v1/socket?token=<JWT>
    ```

    ## Phoenix Channels Protocol
    This API uses Phoenix Channels protocol (https://hexdocs.pm/phoenix/channels.html):

    1. **Join**: Client sends `{"topic": "dashboard:<org_id>", "event": "phx_join", "payload": {}, "ref": "1"}`
    2. **Server Reply**: `{"topic": "dashboard:<org_id>", "event": "phx_reply", "payload": {"status": "ok", "response": {}}, "ref": "1"}`
    3. **Events**: Server pushes `{"topic": "dashboard:<org_id>", "event": "control_updated", "payload": {...}}`
    4. **Heartbeat**: Client sends `{"topic": "phoenix", "event": "heartbeat", "payload": {}, "ref": "2"}` every 30s

    ## Multi-Tenancy
    All topics include `org_id` to enforce multi-tenant isolation. Server verifies JWT `org_id` claim matches topic `org_id`.

    ## Presence
    Phoenix Presence tracks connected users. Clients receive `presence_diff` events when team members join/leave.

  contact:
    name: NeonCompliance API Support
    email: api@neoncompliance.io

servers:
  production:
    host: api.neoncompliance.io
    pathname: /v1/socket
    protocol: wss
    description: Production WebSocket server
    security:
      - $ref: '#/components/securitySchemes/jwtToken'

  development:
    host: localhost:4000
    pathname: /socket
    protocol: ws
    description: Local development WebSocket server
    security:
      - $ref: '#/components/securitySchemes/jwtToken'

channels:
  dashboardTopic:
    address: 'dashboard:{orgId}'
    description: |
      Real-time dashboard updates for compliance readiness and control status changes.

      **Topic Format**: `dashboard:<org_id>` (e.g., `dashboard:123e4567-e89b-12d3-a456-426614174000`)

      **Events**:
      - `readiness_updated` - Emitted when overall readiness percentage changes
      - `control_updated` - Emitted when a control status changes
      - `scan_completed` - Emitted when an evidence scan completes

    parameters:
      orgId:
        description: Organization UUID from JWT claim
        schema:
          type: string
          format: uuid

    messages:
      readinessUpdated:
        $ref: '#/components/messages/ReadinessUpdated'
      controlUpdated:
        $ref: '#/components/messages/ControlUpdated'
      scanCompletedNotification:
        $ref: '#/components/messages/ScanCompletedNotification'
      presenceDiff:
        $ref: '#/components/messages/PresenceDiff'

  scanProgressTopic:
    address: 'scan:{scanId}'
    description: |
      Real-time progress updates for active evidence scans.

      **Topic Format**: `scan:<scan_id>` (e.g., `scan:789e4567-e89b-12d3-a456-426614174000`)

      **Events**:
      - `progress_updated` - Emitted every 5 seconds during scan
      - `scan_completed` - Emitted when scan finishes (success or failure)
      - `scan_failed` - Emitted when scan encounters unrecoverable error

    parameters:
      scanId:
        description: Evidence scan UUID
        schema:
          type: string
          format: uuid

    messages:
      progressUpdated:
        $ref: '#/components/messages/ProgressUpdated'
      scanCompleted:
        $ref: '#/components/messages/ScanCompleted'
      scanFailed:
        $ref: '#/components/messages/ScanFailed'

  evidenceTopic:
    address: 'evidence:{orgId}'
    description: |
      Real-time notifications for new evidence items collected.

      **Topic Format**: `evidence:<org_id>`

      **Events**:
      - `evidence_collected` - Emitted when new evidence item is created

    parameters:
      orgId:
        description: Organization UUID from JWT claim
        schema:
          type: string
          format: uuid

    messages:
      evidenceCollected:
        $ref: '#/components/messages/EvidenceCollected'

  systemTopic:
    address: 'system:{orgId}'
    description: |
      System-level notifications (integration errors, credential expiry warnings).

      **Topic Format**: `system:<org_id>`

      **Events**:
      - `integration_error` - Emitted when integration connection fails
      - `credential_expiry_warning` - Emitted 7 days before credential expiry

    parameters:
      orgId:
        description: Organization UUID from JWT claim
        schema:
          type: string
          format: uuid

    messages:
      integrationError:
        $ref: '#/components/messages/IntegrationError'
      credentialExpiryWarning:
        $ref: '#/components/messages/CredentialExpiryWarning'

operations:
  joinDashboard:
    action: receive
    channel:
      $ref: '#/channels/dashboardTopic'
    summary: Subscribe to dashboard updates
    description: Client joins dashboard topic to receive real-time compliance updates
    messages:
      - $ref: '#/components/messages/ReadinessUpdated'
      - $ref: '#/components/messages/ControlUpdated'
      - $ref: '#/components/messages/ScanCompletedNotification'
      - $ref: '#/components/messages/PresenceDiff'

  joinScanProgress:
    action: receive
    channel:
      $ref: '#/channels/scanProgressTopic'
    summary: Subscribe to scan progress
    description: Client joins scan topic to receive real-time progress updates
    messages:
      - $ref: '#/components/messages/ProgressUpdated'
      - $ref: '#/components/messages/ScanCompleted'
      - $ref: '#/components/messages/ScanFailed'

  joinEvidence:
    action: receive
    channel:
      $ref: '#/channels/evidenceTopic'
    summary: Subscribe to evidence notifications
    description: Client joins evidence topic to receive notifications when evidence is collected
    messages:
      - $ref: '#/components/messages/EvidenceCollected'

  joinSystem:
    action: receive
    channel:
      $ref: '#/channels/systemTopic'
    summary: Subscribe to system notifications
    description: Client joins system topic to receive integration errors and warnings
    messages:
      - $ref: '#/components/messages/IntegrationError'
      - $ref: '#/components/messages/CredentialExpiryWarning'

components:
  securitySchemes:
    jwtToken:
      type: httpApiKey
      name: token
      in: query
      description: JWT token with org_id claim appended to WebSocket URL query string

  messages:
    ReadinessUpdated:
      name: readiness_updated
      title: Readiness Updated
      summary: Emitted when overall compliance readiness percentage changes
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ReadinessUpdatedPayload'

    ControlUpdated:
      name: control_updated
      title: Control Updated
      summary: Emitted when a control status changes
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ControlUpdatedPayload'

    ScanCompletedNotification:
      name: scan_completed
      title: Scan Completed (Dashboard)
      summary: Emitted on dashboard topic when any scan completes
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ScanCompletedNotificationPayload'

    PresenceDiff:
      name: presence_diff
      title: Presence Diff
      summary: Emitted when team members join/leave dashboard
      contentType: application/json
      payload:
        $ref: '#/components/schemas/PresenceDiffPayload'

    ProgressUpdated:
      name: progress_updated
      title: Progress Updated
      summary: Emitted every 5 seconds during active scan
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ProgressUpdatedPayload'

    ScanCompleted:
      name: scan_completed
      title: Scan Completed
      summary: Emitted when scan finishes successfully
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ScanCompletedPayload'

    ScanFailed:
      name: scan_failed
      title: Scan Failed
      summary: Emitted when scan encounters unrecoverable error
      contentType: application/json
      payload:
        $ref: '#/components/schemas/ScanFailedPayload'

    EvidenceCollected:
      name: evidence_collected
      title: Evidence Collected
      summary: Emitted when new evidence item is created
      contentType: application/json
      payload:
        $ref: '#/components/schemas/EvidenceCollectedPayload'

    IntegrationError:
      name: integration_error
      title: Integration Error
      summary: Emitted when integration connection fails
      contentType: application/json
      payload:
        $ref: '#/components/schemas/IntegrationErrorPayload'

    CredentialExpiryWarning:
      name: credential_expiry_warning
      title: Credential Expiry Warning
      summary: Emitted 7 days before credential expiry
      contentType: application/json
      payload:
        $ref: '#/components/schemas/CredentialExpiryWarningPayload'

  schemas:
    ReadinessUpdatedPayload:
      type: object
      properties:
        program_id:
          type: string
          format: uuid
        previous_percentage:
          type: number
          format: decimal
          example: 20.0
        new_percentage:
          type: number
          format: decimal
          example: 23.5
        control_breakdown:
          type: object
          properties:
            not_started:
              type: integer
            in_progress:
              type: integer
            compliant:
              type: integer
            non_compliant:
              type: integer
        updated_at:
          type: string
          format: date-time
        updated_by:
          type: object
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
            email:
              type: string

    ControlUpdatedPayload:
      type: object
      properties:
        control_id:
          type: string
          format: uuid
        program_id:
          type: string
          format: uuid
        control_code:
          type: string
          example: "CC6.1"
        control_title:
          type: string
        previous_status:
          type: string
          enum: [not_started, in_progress, compliant, non_compliant]
        new_status:
          type: string
          enum: [not_started, in_progress, compliant, non_compliant]
        updated_at:
          type: string
          format: date-time
        updated_by:
          type: object
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
            email:
              type: string

    ScanCompletedNotificationPayload:
      type: object
      properties:
        scan_id:
          type: string
          format: uuid
        integration_provider:
          type: string
          enum: [aws, gcp, azure, github, okta]
        resources_scanned:
          type: integer
        evidence_items_collected:
          type: integer
        controls_updated:
          type: integer
          description: Number of controls that received new evidence
        completed_at:
          type: string
          format: date-time

    PresenceDiffPayload:
      type: object
      description: Phoenix Presence diff event
      properties:
        joins:
          type: object
          additionalProperties:
            type: object
            properties:
              metas:
                type: array
                items:
                  type: object
                  properties:
                    user_id:
                      type: string
                      format: uuid
                    name:
                      type: string
                    email:
                      type: string
                    phx_ref:
                      type: string
        leaves:
          type: object
          additionalProperties:
            type: object
            properties:
              metas:
                type: array
                items:
                  type: object
                  properties:
                    user_id:
                      type: string
                      format: uuid
                    phx_ref:
                      type: string

    ProgressUpdatedPayload:
      type: object
      properties:
        scan_id:
          type: string
          format: uuid
        progress_percentage:
          type: integer
          minimum: 0
          maximum: 100
        current_operation:
          type: string
          example: "Scanning S3 buckets... 15/47"
        resources_scanned:
          type: integer
        evidence_items_collected:
          type: integer
        updated_at:
          type: string
          format: date-time

    ScanCompletedPayload:
      type: object
      properties:
        scan_id:
          type: string
          format: uuid
        total_resources:
          type: integer
        total_evidence_items:
          type: integer
        compliant_resources:
          type: integer
        non_compliant_resources:
          type: integer
        duration_seconds:
          type: integer
        completed_at:
          type: string
          format: date-time

    ScanFailedPayload:
      type: object
      properties:
        scan_id:
          type: string
          format: uuid
        error_code:
          type: string
          enum: [CREDENTIAL_INVALID, NETWORK_TIMEOUT, PERMISSION_DENIED, RATE_LIMIT]
        error_message:
          type: string
        resources_scanned_before_failure:
          type: integer
        evidence_items_collected_before_failure:
          type: integer
        failed_at:
          type: string
          format: date-time
        retry_recommended:
          type: boolean

    EvidenceCollectedPayload:
      type: object
      properties:
        evidence_id:
          type: string
          format: uuid
        scan_id:
          type: string
          format: uuid
        control_code:
          type: string
          example: "CC6.1"
        control_title:
          type: string
        resource_type:
          type: string
          example: "s3_bucket"
        resource_arn:
          type: string
        result:
          type: string
          enum: [compliant, non_compliant, not_applicable]
        collected_at:
          type: string
          format: date-time

    IntegrationErrorPayload:
      type: object
      properties:
        integration_id:
          type: string
          format: uuid
        provider:
          type: string
          enum: [aws, gcp, azure, github, okta]
        error_code:
          type: string
          enum: [CREDENTIAL_EXPIRED, PERMISSION_DENIED, CONNECTION_FAILED]
        error_message:
          type: string
        occurred_at:
          type: string
          format: date-time
        action_required:
          type: string
          description: User-friendly action to resolve error
          example: "Refresh AWS credentials in integration settings"

    CredentialExpiryWarningPayload:
      type: object
      properties:
        integration_id:
          type: string
          format: uuid
        provider:
          type: string
          enum: [aws, gcp, azure, github, okta]
        expires_at:
          type: string
          format: date-time
        days_remaining:
          type: integer
          example: 7
        action_required:
          type: string
          example: "Rotate AWS credentials before they expire"
