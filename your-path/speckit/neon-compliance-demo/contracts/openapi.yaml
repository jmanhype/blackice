openapi: 3.1.0
info:
  title: NeonCompliance API
  version: 1.0.0
  description: |
    REST API for NeonCompliance - AI-native compliance platform.

    ## Authentication
    All endpoints except `/health` require Bearer token authentication.

    ## Multi-Tenancy
    All requests are scoped to the authenticated user's organization via JWT `org_id` claim.

    ## Rate Limiting
    - 100 requests/minute per user for mutations
    - 500 requests/minute per user for queries

  contact:
    name: NeonCompliance API Support
    email: api@neoncompliance.io
  license:
    name: Proprietary

servers:
  - url: https://api.neoncompliance.io/v1
    description: Production
  - url: http://localhost:4000/api/v1
    description: Local development

tags:
  - name: Organizations
    description: Organization onboarding and management
  - name: Frameworks
    description: Compliance framework catalog
  - name: Programs
    description: Compliance program management
  - name: Controls
    description: Control status and evidence
  - name: Integrations
    description: Cloud provider and SaaS integrations
  - name: Scans
    description: Evidence collection scans
  - name: Health
    description: Service health checks

paths:
  /health:
    get:
      summary: Health check endpoint
      description: Returns service health status (no authentication required)
      operationId: getHealth
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok]
                  timestamp:
                    type: string
                    format: date-time

  /organizations:
    post:
      summary: Create organization (onboarding)
      description: Register a new organization and create initial admin user
      operationId: createOrganization
      tags:
        - Organizations
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationRequest'
      responses:
        '201':
          description: Organization created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Domain already claimed by another organization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /organizations/me:
    get:
      summary: Get current organization
      description: Returns authenticated user's organization details
      operationId: getCurrentOrganization
      tags:
        - Organizations
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Organization details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /frameworks:
    get:
      summary: List available frameworks
      description: Returns all compliance frameworks (SOC 2, HIPAA, ISO 27001)
      operationId: listFrameworks
      tags:
        - Frameworks
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of frameworks
          content:
            application/json:
              schema:
                type: object
                properties:
                  frameworks:
                    type: array
                    items:
                      $ref: '#/components/schemas/FrameworkResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /programs:
    post:
      summary: Generate compliance program
      description: Instantiate a compliance program for selected framework
      operationId: createProgram
      tags:
        - Programs
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProgramRequest'
      responses:
        '201':
          description: Program created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProgramResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Program already exists for this framework
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      summary: List organization's programs
      description: Returns all compliance programs for authenticated user's organization
      operationId: listPrograms
      tags:
        - Programs
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of programs
          content:
            application/json:
              schema:
                type: object
                properties:
                  programs:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProgramResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /programs/{programId}/dashboard:
    get:
      summary: Get dashboard data
      description: Returns compliance readiness and control breakdown for program
      operationId: getDashboard
      tags:
        - Programs
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/programId'
      responses:
        '200':
          description: Dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /programs/{programId}/controls:
    get:
      summary: List program controls
      description: Returns all controls for a compliance program with status and evidence
      operationId: listControls
      tags:
        - Controls
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/programId'
        - name: status
          in: query
          description: Filter by control status
          schema:
            type: string
            enum: [not_started, in_progress, compliant, non_compliant]
      responses:
        '200':
          description: List of controls
          content:
            application/json:
              schema:
                type: object
                properties:
                  controls:
                    type: array
                    items:
                      $ref: '#/components/schemas/ControlResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /controls/{controlId}:
    patch:
      summary: Update control status
      description: Update control status and notes
      operationId: updateControl
      tags:
        - Controls
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/controlId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateControlRequest'
      responses:
        '200':
          description: Control updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ControlResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /integrations:
    post:
      summary: Create integration account
      description: Connect a cloud provider or SaaS tool
      operationId: createIntegration
      tags:
        - Integrations
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateIntegrationRequest'
      responses:
        '201':
          description: Integration created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Integration already exists for this provider
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      summary: List integrations
      description: Returns all integration accounts for organization
      operationId: listIntegrations
      tags:
        - Integrations
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of integrations
          content:
            application/json:
              schema:
                type: object
                properties:
                  integrations:
                    type: array
                    items:
                      $ref: '#/components/schemas/IntegrationResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /integrations/{integrationId}:
    patch:
      summary: Update integration
      description: Update integration credentials or configuration
      operationId: updateIntegration
      tags:
        - Integrations
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/integrationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateIntegrationRequest'
      responses:
        '200':
          description: Integration updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /scans:
    post:
      summary: Trigger evidence scan
      description: Manually trigger evidence collection for an integration
      operationId: createScan
      tags:
        - Scans
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateScanRequest'
      responses:
        '201':
          description: Scan created and queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScanResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Integration not found or not connected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      summary: List scans
      description: Returns all evidence scans for organization
      operationId: listScans
      tags:
        - Scans
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          description: Filter by scan status
          schema:
            type: string
            enum: [pending, running, completed, failed]
        - name: limit
          in: query
          description: Maximum scans to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: List of scans
          content:
            application/json:
              schema:
                type: object
                properties:
                  scans:
                    type: array
                    items:
                      $ref: '#/components/schemas/ScanResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /scans/{scanId}:
    get:
      summary: Get scan details
      description: Returns scan progress and results
      operationId: getScan
      tags:
        - Scans
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/scanId'
      responses:
        '200':
          description: Scan details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScanDetailResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token with org_id claim

  parameters:
    programId:
      name: programId
      in: path
      required: true
      description: Compliance program UUID
      schema:
        type: string
        format: uuid

    controlId:
      name: controlId
      in: path
      required: true
      description: Organization control UUID
      schema:
        type: string
        format: uuid

    integrationId:
      name: integrationId
      in: path
      required: true
      description: Integration account UUID
      schema:
        type: string
        format: uuid

    scanId:
      name: scanId
      in: path
      required: true
      description: Evidence scan UUID
      schema:
        type: string
        format: uuid

  schemas:
    CreateOrganizationRequest:
      type: object
      required:
        - name
        - domain
        - size_range
        - industry
        - admin_email
        - admin_name
        - admin_password
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
          example: "Acme Corporation"
        domain:
          type: string
          pattern: '^[a-z0-9-]+\.[a-z]{2,}$'
          example: "acme.com"
        size_range:
          type: string
          enum: [small, medium, large, enterprise]
          example: "small"
        industry:
          type: string
          minLength: 1
          maxLength: 100
          example: "SaaS"
        tech_stack:
          type: array
          items:
            type: string
          example: ["AWS", "Okta"]
        admin_email:
          type: string
          format: email
          example: "admin@acme.com"
        admin_name:
          type: string
          minLength: 1
          maxLength: 200
          example: "Alice Admin"
        admin_password:
          type: string
          minLength: 12
          example: "correct-horse-battery-staple"

    OrganizationResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        domain:
          type: string
        size_range:
          type: string
          enum: [small, medium, large, enterprise]
        industry:
          type: string
        tech_stack:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time

    FrameworkResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        code:
          type: string
          example: "SOC2"
        name:
          type: string
          example: "SOC 2 Type II"
        description:
          type: string
        control_count:
          type: integer
          example: 150
        typical_timeline_days:
          type: integer
          example: 180

    CreateProgramRequest:
      type: object
      required:
        - framework_id
      properties:
        framework_id:
          type: string
          format: uuid
        target_completion_date:
          type: string
          format: date
          description: Optional target completion date

    ProgramResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        organization_id:
          type: string
          format: uuid
        framework:
          $ref: '#/components/schemas/FrameworkResponse'
        started_at:
          type: string
          format: date-time
        target_completion_date:
          type: string
          format: date
          nullable: true
        readiness_percentage:
          type: number
          format: decimal
          example: 23.5
        created_at:
          type: string
          format: date-time

    DashboardResponse:
      type: object
      properties:
        program_id:
          type: string
          format: uuid
        readiness_percentage:
          type: number
          format: decimal
          example: 23.5
        control_breakdown:
          type: object
          properties:
            not_started:
              type: integer
              example: 100
            in_progress:
              type: integer
              example: 30
            compliant:
              type: integer
              example: 15
            non_compliant:
              type: integer
              example: 5
        frameworks:
          type: array
          items:
            $ref: '#/components/schemas/FrameworkResponse'
        recent_activity:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [control_updated, scan_completed, evidence_added]
              timestamp:
                type: string
                format: date-time
              description:
                type: string

    ControlResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        program_id:
          type: string
          format: uuid
        control_template:
          type: object
          properties:
            code:
              type: string
              example: "CC6.1"
            title:
              type: string
            description:
              type: string
            automation_capability:
              type: string
              enum: [automated, manual, hybrid]
        status:
          type: string
          enum: [not_started, in_progress, compliant, non_compliant]
        assigned_to:
          type: object
          nullable: true
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
            email:
              type: string
        notes:
          type: string
          nullable: true
        evidence_count:
          type: integer
          description: Number of evidence items supporting this control
        last_assessed_at:
          type: string
          format: date-time
          nullable: true
        updated_at:
          type: string
          format: date-time

    UpdateControlRequest:
      type: object
      properties:
        status:
          type: string
          enum: [not_started, in_progress, compliant, non_compliant]
        assigned_to_id:
          type: string
          format: uuid
          nullable: true
        notes:
          type: string

    CreateIntegrationRequest:
      type: object
      required:
        - provider
        - credentials
      properties:
        provider:
          type: string
          enum: [aws, gcp, azure, github, okta]
        credentials:
          type: object
          description: Provider-specific credentials (encrypted before storage)
          oneOf:
            - $ref: '#/components/schemas/AwsCredentials'
        config:
          type: object
          description: Provider-specific configuration
          example:
            region: "us-east-1"
            account_id: "123456789012"

    AwsCredentials:
      type: object
      required:
        - access_key_id
        - secret_access_key
      properties:
        access_key_id:
          type: string
          example: "AKIAIOSFODNN7EXAMPLE"
        secret_access_key:
          type: string
          format: password
          example: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
        session_token:
          type: string
          description: Optional session token for temporary credentials
        role_arn:
          type: string
          description: Optional IAM role to assume
          example: "arn:aws:iam::123456789012:role/NeonComplianceRole"

    IntegrationResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        provider:
          type: string
          enum: [aws, gcp, azure, github, okta]
        status:
          type: string
          enum: [connected, error, disconnected]
        last_sync_at:
          type: string
          format: date-time
          nullable: true
        error_message:
          type: string
          nullable: true
        config:
          type: object
        created_at:
          type: string
          format: date-time

    UpdateIntegrationRequest:
      type: object
      properties:
        credentials:
          type: object
          description: Updated credentials (optional)
        config:
          type: object
          description: Updated configuration (optional)

    CreateScanRequest:
      type: object
      required:
        - integration_id
      properties:
        integration_id:
          type: string
          format: uuid

    ScanResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        integration_id:
          type: string
          format: uuid
        provider:
          type: string
          enum: [aws, gcp, azure, github, okta]
        status:
          type: string
          enum: [pending, running, completed, failed]
        progress_percentage:
          type: integer
          minimum: 0
          maximum: 100
        current_operation:
          type: string
          nullable: true
          example: "Scanning S3 buckets... 15/47"
        resources_scanned_count:
          type: integer
        evidence_items_collected:
          type: integer
        started_at:
          type: string
          format: date-time
        ended_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    ScanDetailResponse:
      allOf:
        - $ref: '#/components/schemas/ScanResponse'
        - type: object
          properties:
            evidence_items:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  control_code:
                    type: string
                    example: "CC6.1"
                  resource_type:
                    type: string
                    example: "s3_bucket"
                  resource_arn:
                    type: string
                    example: "arn:aws:s3:::acme-logs"
                  result:
                    type: string
                    enum: [compliant, non_compliant, not_applicable]
                  collected_at:
                    type: string
                    format: date-time
                  remediation_steps:
                    type: array
                    items:
                      type: string
                    example: ["Enable default encryption", "Set encryption to AES256"]

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: "DOMAIN_ALREADY_CLAIMED"
            message:
              type: string
              example: "The domain 'acme.com' is already claimed by another organization."
            details:
              type: object
              nullable: true

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Unauthorized:
      description: Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

security:
  - bearerAuth: []
